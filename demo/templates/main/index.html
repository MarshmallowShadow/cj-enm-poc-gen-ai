{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gen AI Demo</title>
    <link rel="icon" type="image/x-icon" href="{% static 'demo/img/favicon.png' %}">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{% static '/demo/css/bootstrap.min.css' %}">
    <script src="{% static '/demo/js/jquery-3.7.1.min.js' %}"></script>
    <script src="{% static '/demo/js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static '/demo/js/showdown.min.js' %}"></script>
</head>
<style>
    #loadingIcon {
        width: 30px;
    }
    #loadingText {
        font-family: "Lucida Console", monospace;
    }
    #resultContainer {
        min-height: 100px;
        font-family: "Lucida Console", monospace;
        user-select: text;
    }
</style>
<body class="mx-auto w-75 user-select-none">
    <div>
        <div id="header" class="container-fluid p-4 bg-primary text-white text-center">
            <h1>Gen AI Demo</h1>
        </div>
        <div id="body" class="py-3">
            <div class="container-fluid my-3">
                <p>1. 해석할 파일을 업로드해주세요:</p>
                <label id="fileLabel" for="analyzeFile" class="btn btn-info text-white">파일 업로드</label><span id="fileName" class="mx-3"></span>
                <input id="analyzeFile" type="file" name="attachment" hidden accept="">
                <div class="form-check form-switch my-3">
                    <input id="uploadYn" class="form-check-input" type="checkbox" name="uploadYn" value="Y">
                    <label for="uploadYn" class="form-check-label">파일을 클라우드에 저장 (공사 중)</label>
                </div>
            </div>
            <hr>
            <div class="container-fluid my-3">
                <p>2. 질문을 선택해주세요:</p>
                <ul class="list-group my-2">
                    <li class="container-fluid list-group-item question" data-value="question1">한국어로 각 케릭터 입장에서 문서 내용을 해석해주세요.</li>
                    <li class="container-fluid list-group-item question" data-value="question2">일본어로 각 케릭터 입장에서 문서 내용을 해석해주세요.</li>
                    <li class="container-fluid list-group-item question" data-value="question3">독일어로 각 케릭터 입장에서 문서 내용을 해석해주세요.</li>
                    <li class="container-fluid list-group-item question" data-value="question4">영어로 각 케릭터 입장에서 문서 내용을 해석해주세요.</li>
                </ul>
                <button id="btnSubmit" class="btn btn-primary">해석하기</button> <span id="loadingText" style="display: none;"><img alt="" id="loadingIcon" src="{% static 'demo/img/loading.gif' %}">해석 중...</span>
            </div>
            <hr>
            <div id="ResponseContainer" class="container-fluid my-3">
                <p>3. 답변 결과:</p>
                <div id="resultContainer" class="container-fluid border p-2 my-3 bg-light">
                    Here is where a sample response will be displayed.
                </div>
            </div>
        </div>
    </div>
</body>
<script type="text/javascript">
    window.CSRF_TOKEN = "{{ csrf_token }}";

    //로딩 중인지 확인
    let loading = false;

    const fileTypes = ["text/plain", "application/rtf", "text/markdown", "text/html", "application/xml", "text/csv", "application/json", "application/pdf", "application/msword", "application/vnd.openxmlformats-officedocument.wordprocessingml.document", "application/vnd.oasis.opendocument.text"];

    $(document).ready(function() {
        let accept = "";
        fileTypes.forEach(type => accept += type + ", ");
        $("#analyzeFile").attr("accept", accept);
    })

    //파일명, 크기 표시
    $("#analyzeFile").on("change", function(e) {
        let fileName = "";
        if(e.target.files[0]) {
            if(fileTypes.indexOf(e.target.files[0].type) < 0) {
                alert("해석 불가능한 파일 형식입니다.");
                return false;
            }

            let fileSize = getFileSize(e.target.files[0]);
            fileName = e.target.files[0].name + " (" + fileSize + ")";
        }

        $("#fileName").text(fileName);
        return true;
    });

    //선택된 질문 활성화/비활성화
    $(".question").on("click", function() {
        let active = $(this).hasClass("active");
        $(".question").removeClass("active");
        if(!active) $(this).addClass("active");
    });

    //파일/질문 해석 로직
    $("#btnSubmit").on("click", function(){
        //해석 중
        if(loading) {
            alert("해석 중입니다. 잠시만 기다려주세요.");
            return;
        }

        //첨부 파일 확인
        let attachment = $("#analyzeFile")[0].files[0];
        if(!attachment) {
            alert("해석할 파일을 첨부해주세요.");
            return;
        }

        //선택한 질문 없음
        let questionType = $(".active").attr("data-value");
        if(!questionType) {
            alert("질문을 선택해주세요.");
            return;
        }

        loading = true;
        $("#loadingText").show();

        let uploadYn = $("#uploadYn").is(":checked");

        let formData = new FormData();
        formData.append("uploadYn", uploadYn);
        formData.append("attachment", attachment);
        formData.append("questionType", questionType);
        formData.append("csrfmiddlewaretoken", window.CSRF_TOKEN);

        $.ajax({
            url: "/summarize",
            type: "POST",
            data: formData,
            contentType: false,
            processData: false,
            success: function(data) {
                const converter = new showdown.Converter();
                $("#resultContainer").html(converter.makeHtml(data.result));

                loading = false;
                $("#loadingText").hide();
            },
            error: function(xhr, ajaxOptions, error) {
                console.log(xhr);
                alert('오류가 발생했습니다. 다시 시도하세요.');
                loading = false;
                $("#loadingText").hide();
            }
        })
    });

    //표시할 파일 크기 계산 로직
    const getFileSize = function(file) {
        let size = file.size;
        let scale = ["B", "KB", "MB", "GB", "TB"];
        let scaleIndex = 0;

        while(size > 1024 && scaleIndex < scale.length) {
            size = Math.round(size / 1024 * 100) / 100
            scaleIndex++;
        }

        return size + scale[scaleIndex];
    }
</script>
</html>